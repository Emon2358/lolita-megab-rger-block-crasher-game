<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lolita megabürger ブロック崩し - Ultimate Edition</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    #gameCanvas { display: block; background: #000; }
    /* HUD */
    #hud { position: absolute; top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 8px; font-family: sans-serif; color: #fff; z-index: 20; }
    #hud button { font-size: 1rem; padding: 5px 10px; }
    /* Overlay Screens */
    .overlay { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background: rgba(0,0,0,0.8); color:#fff; font-family:sans-serif; z-index: 30; }
    .overlay.hidden { display:none; }
    .overlay button { font-size:1.5rem; padding:10px 20px; margin-top:10px; }
    /* Settings Panel */
    #settingsPanel { position:absolute; right:10px; top:50px; width:200px; background:rgba(0,0,0,0.7); padding:10px; border-radius:8px; color:#fff; z-index:25; display:none; }
    #settingsPanel label, #settingsPanel select { display:block; margin-bottom:8px; }
    /* Leaderboard */
    #leaderboard { position:absolute; left:10px; top:50px; width:200px; background:rgba(0,0,0,0.7); padding:10px; border-radius:8px; color:#fff; z-index:25; }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hud">
    <button id="pauseBtn">PAUSE</button>
    <div>
      <span id="scoreDisplay">Score: 0</span> |
      <span id="stageDisplay">Stage: 1</span>
    </div>
    <button id="settingsBtn">⚙️</button>
  </div>
  <div id="settingsPanel">
    <label>Volume: <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5"></label>
    <label>Difficulty: <select id="difficultySelect"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option></select></label>
    <label>Skin: <select id="skinSelect"><option value="default">Default</option><option value="neon">Neon</option><option value="dark">Dark</option></select></label>
  </div>
  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <ol id="leaderList"></ol>
  </div>
  <div id="startScreen" class="overlay">
    <img id="logo" src="https://i1.sndcdn.com/artworks-aGFKdOkmBGtt9l2Z-X1HLkw-t240x240.jpg" alt="Logo">
    <h1>lolita megabürger ブロック崩し</h1>
    <button id="startButton">START</button>
  </div>
  <div id="gameOverScreen" class="overlay hidden">
    <h1>GAME OVER</h1>
    <p>score: <span id="finalScore">0</span></p>
    <p>high score: <span id="highScoreDisplay">0</span></p>
    <button id="restartButton">RESTART</button>
  </div>
  <script type="module">
  // --- Settings & Storage ---
  const highScoreKey = 'lm_breakout_high';
  let highScore = localStorage.getItem(highScoreKey) || 0;
  document.getElementById('highScoreDisplay').textContent = highScore;
  const settings = { volume:0.5, difficulty:'normal', skin:'default' };
  
  // --- Canvas Setup ---
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = window.innerWidth;
  let H = canvas.height = window.innerHeight;
  
  // --- Asset Preloader ---
  const assets = {};
  const assetList = {
    ball:'https://i.pinimg.com/736x/29/35/fd/2935fd34d01e87d15eea56212bd40b17.jpg',
    bgTile:'https://i.pinimg.com/736x/3d/79/a9/3d79a96947789566d9e60db9a4055d8a.jpg',
    paddle:'https://i.pinimg.com/736x/ce/43/09/ce4309d56d296585fc3e0133799e625f.jpg',
    wall:'https://i.pinimg.com/736x/e4/ec/39/e4ec39fde327ac46e011473f063086ff.jpg',
    explosion:'https://i.pinimg.com/originals/ed/1e/98/ed1e98dab7f9d865ee61f075f77ec18d.gif'
  };
  let loaded = 0, totalAssets = Object.keys(assetList).length;
  function loadAssets(callback){
    for(let key in assetList){
      const img = new Image(); img.src = assetList[key];
      img.onload = ()=>{ assets[key]=img; if(++loaded===totalAssets) callback(); };
    }
  }

  // --- Game Entities ---
  class Block { constructor(x,y,w,h,img,dur){ this.x=x; this.y=y; this.w=w; this.h=h; this.img=img; this.dur=dur; this.maxDur=dur; this.alive=true;} }
  class Ball { constructor(x,y,vx,vy){ this.x=x; this.y=y; this.r=12; this.vx=vx; this.vy=vy; } }
  class Paddle { constructor(){ this.w=120; this.h=16; this.x=(W-this.w)/2; this.y=H-60; this.speed=8; } }
  class PowerUp { constructor(x,y,type){ this.x=x; this.y=y; this.r=10; this.vy=2; this.type=type; } update(){ this.y+=this.vy;} draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,2*Math.PI); ctx.fillStyle = this.type==='multi'?'yellow':this.type==='widen'?'cyan':'orange'; ctx.fill(); } }

  // --- Variables ---
  let paddle, balls, blocks, powerUps, score, stage;
  let paused=false, gamepadIndex=null;

  // --- Initialize ---
  function resetEntities(){
    paddle=new Paddle();
    balls=[ new Ball(W/2,H/2,5, -5) ];
    blocks=[];
    powerUps=[];
    const cols=10, rows=stage+3;
    const bw=W/cols, bh=24;
    for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
      const dur = Math.ceil(Math.random()*2);
      const img = assets.bgTile;
      blocks.push(new Block(x*bw,50+y*bh,bw-2,bh-2,img,dur));
    }
  }

  // --- Input ---
  const keys={left:false,right:false};
  window.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft') keys.left=true; if(e.key==='ArrowRight') keys.right=true; });
  window.addEventListener('keyup',e=>{ if(e.key==='ArrowLeft') keys.left=false; if(e.key==='ArrowRight') keys.right=false; });
  canvas.addEventListener('touchmove',e=>{ paddle.x = e.touches[0].clientX - paddle.w/2; });

  // --- UI Controls ---
  document.getElementById('startButton').onclick = startGame;
  document.getElementById('restartButton').onclick = ()=>{ document.getElementById('gameOverScreen').classList.add('hidden'); startGame(); };
  document.getElementById('pauseBtn').onclick = ()=>{ paused=!paused; document.getElementById('pauseBtn').textContent = paused?'RESUME':'PAUSE'; if(!paused) requestAnimationFrame(gameLoop); };
  document.getElementById('settingsBtn').onclick = ()=>{ document.getElementById('settingsPanel').style.display = document.getElementById('settingsPanel').style.display==='none'?'block':'none'; };
  document.getElementById('volumeSlider').oninput = e=>{ settings.volume=e.target.value; };
  document.getElementById('difficultySelect').onchange = e=>{ settings.difficulty=e.target.value; };
  document.getElementById('skinSelect').onchange = e=>{ settings.skin=e.target.value; }

  // --- Main ---
  loadAssets(()=>{ document.getElementById('startScreen').classList.remove('hidden'); });

  function startGame(){
    score=0; stage=1;
    document.getElementById('startScreen').classList.add('hidden');
    resetEntities(); requestAnimationFrame(gameLoop);
  }

  function gameLoop(){
    if(paused) return;
    update(); draw();
    if(balls.every(b=>b.y-b.r>H)) return gameOver();
    requestAnimationFrame(gameLoop);
  }

  function update(){
    // Paddle move
    if(keys.left) paddle.x-=paddle.speed;
    if(keys.right) paddle.x+=paddle.speed;
    paddle.x = Math.max(0, Math.min(W-paddle.w,paddle.x));
    // Balls
    balls.forEach(ball=>{
      ball.x+=ball.vx; ball.y+=ball.vy;
      if(ball.x-ball.r<0||ball.x+ball.r>W) ball.vx*=-1;
      if(ball.y-ball.r<0) ball.vy*=-1;
      // Paddle collision
      if(ball.x>paddle.x && ball.x<paddle.x+paddle.w && ball.y+ball.r>paddle.y){ ball.vy*=-1; }
      // Block collision & drops
      blocks.forEach(b=>{
        if(!b.alive) return;
        if(ball.x>b.x && ball.x<b.x+b.w && ball.y-ball.r<b.y+b.h && ball.y+ball.r>b.y){
          b.dur--; ball.vy*=-1;
          if(b.dur<=0){ b.alive=false; score+=100; if(Math.random()<0.2){ const types=['multi','widen','fast']; powerUps.push(new PowerUp(b.x+b.w/2,b.y+b.h/2,types[Math.floor(Math.random()*types.length)])); }}
        }
      });
    });
    // PowerUps
    powerUps = powerUps.filter(p=>{
      p.update();
      // pickup
      if(p.y+p.r>paddle.y && p.x>paddle.x && p.x<paddle.x+paddle.w){ activatePU(p.type); return false; }
      return p.y<H;
    });
    // Stage clear
    if(blocks.every(b=>!b.alive)) { stage++; resetEntities(); }
  }

  function activatePU(type){
    switch(type){
      case 'multi': balls.push(new Ball(W/2,H/2,5,-5)); break;
      case 'widen': paddle.w*=1.5; setTimeout(()=>paddle.w/=1.5,10000); break;
      case 'fast': balls.forEach(b=>{ b.vx*=1.5; b.vy*=1.5; }); setTimeout(()=>balls.forEach(b=>{ b.vx/=1.5; b.vy/=1.5; }),10000); break;
    }
  }

  function draw(){
    // Background
    ctx.fillStyle = ctx.createPattern(assets.bgTile,'repeat'); ctx.fillRect(0,0,W,H);
    // Walls
    ctx.fillStyle = ctx.createPattern(assets.wall,'repeat-y'); ctx.fillRect(0,0,20,H); ctx.fillRect(W-20,0,20,H);
    // Blocks
    blocks.forEach(b=>{
      if(b.alive){ ctx.globalAlpha = b.dur/b.maxDur; ctx.drawImage(assets.bgTile,b.x,b.y,b.w,b.h); ctx.globalAlpha=1; }
    });
    // Paddle
    ctx.drawImage(assets.paddle,paddle.x,paddle.y,paddle.w,paddle.h);
    // Balls
    balls.forEach(ball=>{
      ctx.save(); ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,2*Math.PI); ctx.clip(); ctx.drawImage(assets.ball,ball.x-ball.r,ball.y-ball.r,ball.r*2,ball.r*2); ctx.restore();
    });
    // PowerUps
    powerUps.forEach(p=>p.draw());
    // HUD
    document.getElementById('scoreDisplay').textContent = `Score: ${score}`;
    document.getElementById('stageDisplay').textContent = `Stage: ${stage}`;
  }

  function gameOver(){
    if(score>highScore){ highScore=score; localStorage.setItem(highScoreKey,highScore); }
    document.getElementById('finalScore').textContent = score;
    document.getElementById('highScoreDisplay').textContent = highScore;
    document.getElementById('gameOverScreen').classList.remove('hidden');
  }

  // Responsive
  window.addEventListener('resize',()=>{ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; paddle.y=H-60; });

  // Gamepad support
  window.addEventListener('gamepadconnected',e=>{ gamepadIndex=e.gamepad.index; });
  function pollGamepad(){ if(gamepadIndex!==null){ const gp=navigator.getGamepads()[gamepadIndex]; if(gp.axes[0]<-0.2) keys.left=true; else keys.left=false; if(gp.axes[0]>0.2) keys.right=true; else keys.right=false; } requestAnimationFrame(pollGamepad); }
  pollGamepad();
  </script>
</body>
</html>
